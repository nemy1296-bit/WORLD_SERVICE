<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WORLD SERVICE</title>

<style>
body{
 font-family:'Segoe UI',Tahoma;
 margin:0;
 background:
 linear-gradient(rgba(255,255,255,.95),rgba(255,255,255,.95)),
 url("https://images.unsplash.com/photo-1581092334475-1b1c88c8f7c6");
 background-size:cover;
 min-height:100vh;
}
header{
 background:#fff;
 padding:10px;
 text-align:center;
 box-shadow:0 2px 4px rgba(0,0,0,.1)
}
header img{height:60px}
.card{
 background:#fff;
 padding:15px;
 margin:12px auto;
 border-radius:12px;
 width:90%;
 max-width:420px;
 box-shadow:0 4px 8px rgba(0,0,0,.15)
}
.hidden{display:none}
button,input,select{
 width:100%;
 padding:10px;
 margin:6px 0;
 border-radius:6px;
 border:1px solid #ccc
}
.green{background:#4CAF50;color:#fff}
.blue{background:#2196F3;color:#fff}
.gray{background:#9E9E9E;color:#fff}
.purple{background:#3f51b5;color:#fff}
</style>
</head>

<body>

<header>
<img src="https://worldservice.it/wp-content/uploads/2020/05/logo2_400.png">
</header>

<!-- LOGIN -->
<div class="card hidden" id="login">
<h3>Primo accesso</h3>
<input id="nome" placeholder="Nome">
<input id="cognome" placeholder="Cognome">
<button class="green" onclick="salvaUtente()">SALVA</button>
</div>

<!-- SCAN -->
<div class="card hidden" id="scan">
<h3>Scansiona targa</h3>
<input id="targa" placeholder="Targa (QR o manuale)">
<input id="kmInizio" type="number" placeholder="KM iniziali">
<button class="blue" onclick="avviaMezzo()">AVVIA MEZZO</button>
<button class="gray" onclick="openPresenza()">OGGI NON USO IL MEZZO</button>
</div>

<!-- PRESENZA -->
<div class="card hidden" id="presenza">
<h3>Presenza</h3>
<input id="attivita" placeholder="Attivit√†">
<button class="green" onclick="salvaPresenza('ENTRATA')">ENTRATA</button>
<button class="green" onclick="salvaPresenza('USCITA')">USCITA</button>
</div>

<!-- MENU MEZZO -->
<div class="card hidden" id="menuMezzo">
<select id="comune">
<option value="">Seleziona comune</option>
<option>VESCOVATO</option>
<option>BONEMERSE</option>
</select>
<button id="btnTrasb" class="gray" onclick="showTrasbordo()">TRASBORDO SU MEZZO</button>
<button id="btnImp" class="blue" onclick="showImpianto()">SCARICO IMPIANTO</button>
<button class="purple" onclick="fineServizio()">FINE SERVIZIO</button>
</div>

<!-- TRASBORDO -->
<div class="card hidden" id="trasbordo">
<input id="kmScarico" type="number" placeholder="KM scarico">
<button class="green" onclick="salvaTrasbordo()">SALVA</button>
</div>

<!-- IMPIANTO -->
<div class="card hidden" id="impianto">
<h4>Uscita impianto</h4>
<select id="cer">
<option>20 01 08 Umido</option>
<option>20 01 01 Carta</option>
<option>20 01 02 Vetro</option>
<option>20 01 39 Plastica</option>
<option>20 03 01 Indifferenziato</option>
</select>
<input id="peso" placeholder="Peso (kg)">
<input id="kmImp" type="number" placeholder="KM">
<input type="file" id="foto">
<button class="green" onclick="salvaImpianto()">SALVA</button>
</div>

<button onclick="init()" style="
 position:fixed;
 bottom:15px;
 right:15px;
 border-radius:50%;
 padding:14px;
 background:#4CAF50;
 color:#fff;
 border:none">üè†</button>

<script>
const API="INCOLLA QUI URL WEB APP";

function hideAll(){document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden'))}

function init(){
 hideAll();
 let u=JSON.parse(localStorage.getItem("utente"));
 let m=JSON.parse(localStorage.getItem("mezzo"));
 if(!u){login.classList.remove("hidden");return}
 if(m&&m.attivo){menuMezzo.classList.remove("hidden");return}
 scan.classList.remove("hidden");
}

document.addEventListener("DOMContentLoaded",init);

function salvaUtente(){
 localStorage.setItem("utente",JSON.stringify({nome:nome.value,cognome:cognome.value}));
 init();
}

function openPresenza(){hideAll();presenza.classList.remove("hidden")}

function geo(cb){
 navigator.geolocation.getCurrentPosition(p=>cb(p.coords.latitude+","+p.coords.longitude));
}

function send(d){fetch(API,{method:"POST",body:JSON.stringify(d)})}

async function avviaMezzo(){
 if(!targa.value||!kmInizio.value)return alert("Dati mancanti");
 let res=await fetch(API,{method:"POST",body:JSON.stringify({action:"GET_TARGA",targa:targa.value})});
 let cfg=await res.json();
 if(cfg.error)return alert("Targa non trovata");
 localStorage.setItem("mezzo",JSON.stringify({targa:targa.value,attivo:true,cfg}));
 init();
}

function showTrasbordo(){hideAll();trasbordo.classList.remove("hidden")}
function showImpianto(){hideAll();impianto.classList.remove("hidden")}

function salvaTrasbordo(){
 geo(pos=>{
  send({sheet:"SCARICHI",row:[new Date().toLocaleString(),"TRASBORDO",comune.value,"",kmScarico.value,"","",pos]});
  kmScarico.value="";
  init();
 });
}

function salvaImpianto(){
 if(!kmImp.value)return alert("Inserisci KM");
 geo(pos=>{
  send({sheet:"SCARICHI",row:[new Date().toLocaleString(),"IMPIANTO",comune.value,cer.value,kmImp.value,peso.value,foto.files[0]?.name||"",pos]});
  kmImp.value="";peso.value="";foto.value="";
  init();
 });
}

function salvaPresenza(e){
 let u=JSON.parse(localStorage.getItem("utente"));
 geo(pos=>{
  send({sheet:"PRESENZE",row:[new Date().toLocaleString(),u.nome+" "+u.cognome,e,attivita.value,pos]});
  init();
 });
}

function fineServizio(){
 let m=JSON.parse(localStorage.getItem("mezzo"));
 let kmf=prompt("KM finali");
 geo(pos=>{
  send({sheet:"MEZZI",row:[new Date().toLocaleString(),m.targa,"","",kmf,pos]});
  localStorage.removeItem("mezzo");
  init();
 });
}
</script>
</body>
</html>